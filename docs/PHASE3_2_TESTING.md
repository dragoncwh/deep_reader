# Phase 3.2 OCR 增强 - 手动测试指南

## 测试前准备

### 环境准备
1. 在 Xcode 中打开 `DeepReader/DeepReader.xcodeproj`
2. 选择 iOS 模拟器 (推荐 iPhone 15)
3. Build and Run (Cmd+R)

### 测试数据准备
1. **准备一个扫描件 PDF**（纯图片，无文本层）
   - 可以用手机拍照文档生成
   - 或从网上下载扫描版书籍/论文
2. **准备一个普通 PDF**（有文本层）作为对照

### 如何判断 PDF 是否为扫描件
- 用 Preview.app 打开 PDF
- 尝试选择文字：能选中 = 有文本层；选不中 = 扫描件

---

## 测试用例

### TC-3.2.1: 扫描件检测

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 导入一个扫描件 PDF | 导入成功 |
| 2 | 查看 Xcode Console 日志 | 看到 `needsOCR: true` |
| 3 | 导入一个普通 PDF | 导入成功 |
| 4 | 查看 Xcode Console 日志 | 看到 `needsOCR: false` |

---

### TC-3.2.2: 书架 OCR 状态显示

**前置条件**: 已导入扫描件 PDF

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 查看书架上的扫描件书籍卡片 | 右上角显示扫描图标徽章 (`doc.viewfinder`) |
| 2 | 查看普通 PDF 书籍卡片 | 无徽章 |

---

### TC-3.2.3: 手动触发 OCR

**前置条件**: 已导入扫描件 PDF

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 长按扫描件书籍卡片 | 弹出上下文菜单 |
| 2 | 检查菜单内容 | 包含 "Process Scanned PDF" 选项 |
| 3 | 点击 "Process Scanned PDF" | 菜单关闭，开始处理 |
| 4 | 观察书籍卡片 | 徽章变为圆形进度环 |
| 5 | 长按普通 PDF 书籍卡片 | 菜单中**不显示** "Process Scanned PDF" 选项 |

---

### TC-3.2.4: OCR 进度显示

**前置条件**: 已触发 OCR 处理

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 观察书籍卡片上的进度环 | 进度环从 0% 逐渐填充 |
| 2 | 查看 Xcode Console | 每处理 10 页输出一次进度日志 |
| 3 | 等待 OCR 完成 | 进度环消失，徽章消失 |
| 4 | 查看日志 | 显示完成摘要（成功/失败页数） |

---

### TC-3.2.5: OCR 完成后可搜索

**前置条件**: 扫描件 OCR 已完成

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在书架搜索栏输入扫描件中存在的文字 | 显示搜索结果 |
| 2 | 确认结果来源 | 结果显示该扫描件书籍的书名和页码 |
| 3 | 点击搜索结果 | 跳转到对应书籍和页面 |

---

### TC-3.2.6: OCR 取消（可选）

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 触发 OCR 处理 | 开始处理，显示进度 |
| 2 | 在处理过程中关闭 App | App 关闭 |
| 3 | 重新打开 App | App 正常启动 |
| 4 | 查看该书籍状态 | 仍显示需要 OCR 的徽章（可重新触发） |

---

### TC-3.2.7: 错误处理

**注意**: 此测试较难模拟，主要通过代码审查和日志验证

| 场景 | 预期行为 |
|------|----------|
| 单页 OCR 失败 | 继续处理其他页，日志记录失败页码 |
| PDF 文件损坏/无法打开 | 显示错误状态，日志记录错误原因 |
| 存储失败 | 记录错误，保留已处理的文本 |

**验证方法**: 查看 Xcode Console 中的警告和错误日志

---

## 边界情况测试

| 场景 | 操作 | 预期结果 |
|------|------|----------|
| 空白页 PDF | 导入并触发 OCR | 正常完成，提取文本为空 |
| 单页扫描件 | 导入并触发 OCR | 正常处理，进度直接到 100% |
| 大型扫描件 (100+ 页) | 导入并触发 OCR | 正常处理，进度逐步更新，不卡顿 |
| 同时导入多个扫描件 | 导入多个文件 | 每个都正确标记 needsOCR |
| OCR 进行中打开书籍 | 点击正在处理的书籍 | 书籍正常打开，OCR 继续后台处理 |

---

## 性能注意事项

- **OCR 是 CPU 密集型操作**，处理大型 PDF 可能需要较长时间
- 在模拟器上比真机慢很多
- 建议用 5-10 页的小型扫描件进行测试
- 真机测试效果更接近实际用户体验

---

## 日志关键字参考

在 Xcode Console 中搜索以下关键字：

| 关键字 | 含义 |
|--------|------|
| `needsOCR` | 扫描件检测结果 |
| `Starting OCR` | OCR 开始处理 |
| `OCR progress` | 进度更新 |
| `OCR completed` | 完成摘要 |
| `OCR failed` | 页面 OCR 失败 |
| `OCR cancelled` | OCR 被取消 |

---

## 测试完成检查清单

- [ ] 扫描件导入时自动检测并标记 `needsOCR`
- [ ] 普通 PDF 不被标记为需要 OCR
- [ ] 扫描件书籍卡片显示 OCR 徽章
- [ ] 长按菜单显示 "Process Scanned PDF" 选项
- [ ] OCR 处理时显示进度环
- [ ] OCR 完成后徽章消失
- [ ] OCR 完成后的书籍可被全局搜索到
- [ ] 日志正确记录处理过程
- [ ] 无崩溃或明显 UI 问题
